function test_prob = malware_knn()

load('malware_features');

[idx, ~] = knnsearch(train_feature, test_feature, 'k', 20);

test_sample_number = size(test_feature, 1);
test_prob = zeros(test_sample_number, 9);

for i = 1 : test_sample_number
    prediction = train_labels(idx(i, :));
    for p_idx = 1 : 9
        test_prob(i, p_idx) = sum(prediction == p_idx) ./ 20;
    end
end

test_data_path = '/run/media/kewang/externalHD/Projects/kaggle/malware/test';
test_sample_hist_files = dir(fullfile(test_data_path, '*.hist'));

fid = fopen('submission.csv', 'w');
fprintf(fid, '"Id","Prediction1","Prediction2","Prediction3","Prediction4","Prediction5","Prediction6","Prediction7","Prediction8","Prediction9"\n');
for i = 1 : length(test_sample_hist_files)
    [~, name, ~] = fileparts(test_sample_hist_files(i).name);
    fprintf(fid, '"%s", %f, %f, %f, %f, %f, %f, %f, %f, %f\n',...
        name, ...
        test_prob(i, 1), ...
        test_prob(i, 2), ...
        test_prob(i, 3), ...
        test_prob(i, 4), ...
        test_prob(i, 5), ...
        test_prob(i, 6), ...
        test_prob(i, 7), ...
        test_prob(i, 8), ...
        test_prob(i, 9));
end
fclose(fid);

end